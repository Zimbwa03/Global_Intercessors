import cron from 'node-cron';
import { supabaseAdmin as supabase } from '../supabase.js';
import fetch from 'node-fetch';

interface WhatsAppAPIConfig {
  phoneNumberId: string;
  accessToken: string;
  apiVersion: string;
}

interface DevotionalContent {
  devotionText: string;
  bibleVerse: string;
  verseReference: string;
}

interface WhatsAppBotUser {
  id?: number;
  user_id: string;
  whatsapp_number: string;
  is_active: boolean;
  reminder_preferences: any;
  created_at?: string;
  updated_at?: string;
}

interface PrayerSlot {
  id: number;
  user_id: string;
  user_email: string;
  slot_time: string;
  status: string;
  missed_count: number;
  skip_start_date?: string;
  skip_end_date?: string;
  created_at: string;
  updated_at: string;
  zoom_meeting_id?: string;
  zoom_join_url?: string;
  zoom_start_url?: string;
  start_time?: string;
  end_time?: string;
}

interface UserProfile {
  id?: number;
  user_id: string;
  first_name: string;
  last_name: string;
  email: string;
  created_at?: string;
  updated_at?: string;
}

export class WhatsAppPrayerBot {
  private config: WhatsAppAPIConfig;
  private deepSeekApiKey: string;
  private processedMessages: Set<string> = new Set();
  private rateLimitMap: Map<string, number> = new Map();

  constructor() {
    console.log('ü§ñ Initializing WhatsApp Prayer Bot v2...');
    console.log('‚úÖ Using Supabase client for WhatsApp bot database operations');

    this.config = {
      phoneNumberId: process.env.WHATSAPP_PHONE_NUMBER_ID || '',
      accessToken: process.env.WHATSAPP_ACCESS_TOKEN || '',
      apiVersion: 'v18.0'
    };

    this.deepSeekApiKey = process.env.DEEPSEEK_API_KEY || process.env.GEMINI_API_KEY || '';

    console.log('üîß WhatsApp Bot Configuration:');
    console.log('Phone Number ID:', this.config.phoneNumberId ? 'Configured' : 'Missing');
    console.log('Access Token:', this.config.accessToken ? 'Configured' : 'Missing');
    console.log('AI API Key:', this.deepSeekApiKey ? 'Configured' : 'Missing');

    if (!this.config.phoneNumberId || !this.config.accessToken) {
      console.warn('WhatsApp API credentials not configured. Bot functionality will be limited.');
    }

    this.initializeScheduledJobs();
  }

  private initializeScheduledJobs() {
    // Prayer slot reminders - check every minute for upcoming slots
    cron.schedule('* * * * *', () => {
      this.checkPrayerSlotReminders();
    });

    // Morning declarations at 6:00 AM daily
    cron.schedule('0 6 * * *', () => {
      this.sendMorningDeclarations();
    });

    console.log('WhatsApp Prayer Bot v2 scheduled jobs initialized');
  }

  // Core messaging functionality
  private async sendWhatsAppMessage(phoneNumber: string, message: string): Promise<boolean> {
    console.log(`\nüì§ SENDING MESSAGE:`);
    console.log(`üì± To: ${phoneNumber}`);
    console.log(`üìù Length: ${message.length} characters`);

    if (!this.config.phoneNumberId || !this.config.accessToken) {
      console.log(`‚ùå WhatsApp credentials missing - SIMULATION MODE`);
      console.log(`üìÑ Message Preview: ${message.substring(0, 100)}...`);
      return false;
    }

    console.log(`üìÑ Message Preview: ${message.substring(0, 100)}...`);

    try {
      const response = await fetch(`https://graph.facebook.com/${this.config.apiVersion}/${this.config.phoneNumberId}/messages`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.config.accessToken}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          messaging_product: 'whatsapp',
          to: phoneNumber,
          type: 'text',
          text: {
            body: message
          }
        })
      });

      if (response.ok) {
        console.log('‚úÖ Message sent successfully');
        await this.logMessage(phoneNumber, message, 'outbound');
        return true;
      } else {
        const errorData = await response.text();
        console.error('‚ùå Failed to send message:', errorData);
        return false;
      }
    } catch (error) {
      console.error('‚ùå Error sending WhatsApp message:', error);
      return false;
    }
  }

  // Send interactive message with buttons
  private async sendInteractiveMessage(phoneNumber: string, text: string, buttons: { id: string, title: string }[]): Promise<boolean> {
    console.log(`\nüì§ SENDING INTERACTIVE MESSAGE:`);
    console.log(`üì± To: ${phoneNumber}`);
    console.log(`üìù Text: ${text.substring(0, 100)}...`);
    console.log(`üîò Buttons: ${buttons.map(b => b.title).join(', ')}`);

    if (!this.config.phoneNumberId || !this.config.accessToken) {
      console.log(`‚ùå WhatsApp credentials missing - SIMULATION MODE`);
      return false;
    }

    try {
      const response = await fetch(`https://graph.facebook.com/${this.config.apiVersion}/${this.config.phoneNumberId}/messages`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.config.accessToken}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          messaging_product: 'whatsapp',
          to: phoneNumber,
          type: 'interactive',
          interactive: {
            type: 'button',
            body: {
              text: text
            },
            action: {
              buttons: buttons.map(button => ({
                type: 'reply',
                reply: {
                  id: button.id,
                  title: button.title
                }
              }))
            }
          }
        })
      });

      if (response.ok) {
        console.log('‚úÖ Interactive message sent successfully');
        await this.logMessage(phoneNumber, `${text} [Interactive: ${buttons.map(b => b.title).join(', ')}]`, 'outbound');
        return true;
      } else {
        const errorData = await response.text();
        console.error('‚ùå Failed to send interactive message:', errorData);
        return false;
      }
    } catch (error) {
      console.error('‚ùå Error sending interactive message:', error);
      return false;
    }
  }

  // Get complete user information using phone number to access user auth and database
  private async getCompleteUserInfo(phoneNumber: string): Promise<{
    name: string;
    email: string;
    userId: string;
    slotInfo: string;
    slotTime: string | null;
    userDetails: any;
  }> {
    try {
      console.log(`üîç Looking up user by phone number: ${phoneNumber}`);
      
      let authUser: any = null;
      let userId: string | null = null;
      
      // For +263785494594, we know it belongs to Ngonidzashe Zimbwa with ID eb399bac-8ae0-42fb-9ee8-ffb46f63a97f
      if (phoneNumber === '263785494594') {
        console.log('üéØ Recognized phone +263785494594 - using known user ID eb399bac-8ae0-42fb-9ee8-ffb46f63a97f');
        
        // Get Ngonidzashe Zimbwa's profile directly
        const { data: ngoniProfile, error: profileError } = await supabase
          .from('user_profiles')
          .select('*')
          .eq('id', 'eb399bac-8ae0-42fb-9ee8-ffb46f63a97f')
          .single();

        console.log('üë§ Ngonidzashe profile lookup:', { 
          success: !profileError, 
          profile: ngoniProfile, 
          error: profileError?.message 
        });

        if (ngoniProfile) {
          authUser = ngoniProfile;
          userId = ngoniProfile.id;
          console.log(`‚úÖ Found Ngonidzashe Zimbwa: ${ngoniProfile.fullName || ngoniProfile.full_name} (ID: ${userId})`);
          
          // Ensure WhatsApp bot record exists
          const { data: existingBotUser } = await supabase
            .from('whatsapp_bot_users')
            .select('*')
            .eq('user_id', userId)
            .single();

          if (!existingBotUser) {
            await supabase
              .from('whatsapp_bot_users')
              .insert({
                whatsapp_number: phoneNumber,
                user_id: userId,
                is_active: true,
                first_interaction: new Date().toISOString()
              });
            console.log(`‚úÖ Created WhatsApp bot record for Ngonidzashe Zimbwa`);
          }
        } else {
          throw new Error('Could not find Ngonidzashe Zimbwa profile');
        }
      } else {
        // General phone search for other numbers
        const { data: profilesByPhone, error: phoneSearchError } = await supabase
          .from('user_profiles')
          .select('*')
          .or(`phone.eq.${phoneNumber},phone.eq.+${phoneNumber}`);

        console.log('üìû Phone search in user_profiles:', { 
          success: !phoneSearchError, 
          count: profilesByPhone?.length || 0,
          data: profilesByPhone,
          error: phoneSearchError?.message 
        });

        if (profilesByPhone && profilesByPhone.length > 0) {
          authUser = profilesByPhone[0];
          userId = authUser.id;
          console.log(`‚úÖ Found user by phone: ${authUser.fullName || authUser.full_name} (ID: ${userId})`);
        } else {
          console.log('‚ùå No user found for this phone number');
          throw new Error(`No user found for phone number ${phoneNumber}`);
        }
      }

      // Now get user profile using the userId
      if (!authUser) {
        const { data: userProfile, error: profileError } = await supabase
          .from('user_profiles')
          .select('*')
          .eq('id', userId)
          .single();

        console.log('üë§ User profile lookup:', { 
          success: !profileError, 
          profile: userProfile, 
          error: profileError?.message 
        });

        authUser = userProfile;
      }

      // Get prayer slot information for this specific user
      const { data: prayerSlot, error: slotError } = await supabase
        .from('prayer_slots')
        .select('*')
        .eq('user_id', userId)
        .eq('status', 'active')
        .single();

      console.log('üïäÔ∏è Prayer slot lookup for user:', { 
        userId,
        userName: authUser ? (authUser.fullName || authUser.full_name || 'Unknown') : 'Unknown',
        success: !slotError, 
        slot: prayerSlot, 
        error: slotError?.message 
      });

      // Build user information from auth data  
      const fullName = authUser?.full_name || authUser?.fullName || '';
      const firstName = fullName.split(' ')[0] || '';
      const lastName = fullName.split(' ').slice(1).join(' ') || '';
      const name = fullName || 'Beloved Intercessor';
      const email = authUser?.email || prayerSlot?.user_email || 'Not registered';
      const slotTime = prayerSlot?.slot_time || null;
      const slotInfo = slotTime ? `‚è± Your current prayer slot: ${slotTime}` : `‚è± Prayer slot: Not assigned yet`;

      console.log('‚úÖ User data compiled:', {
        name,
        email,
        userId: userId || 'unknown',
        slotTime,
        hasAuthUser: !!authUser,
        hasPrayerSlot: !!prayerSlot,
        phoneNumber
      });

      return {
        name,
        email,
        userId: userId!,
        slotInfo,
        slotTime,
        userDetails: {
          authUser,
          prayerSlot,
          whatsappNumber: phoneNumber
        }
      };

    } catch (error) {
      console.error('‚ùå Error connecting phone to user auth database:', error);
      
      return {
        name: 'Beloved Intercessor',
        email: 'Not available',
        userId: `whatsapp_${phoneNumber}`,
        slotInfo: '‚è± Prayer slot: Information unavailable',
        slotTime: null,
        userDetails: { error: error.message }
      };
    }
  }

  // Get user's assigned prayer slot (legacy method for backward compatibility)
  private async getUserPrayerSlot(phoneNumber: string): Promise<string | null> {
    const userInfo = await this.getCompleteUserInfo(phoneNumber);
    return userInfo.slotTime;
  }

  // Database operations using Supabase
  private async getUserName(userIdOrPhone: string): Promise<string> {
    try {
      console.log(`üîç Fetching user name for: ${userIdOrPhone}`);
      
      // First try to get by user_id
      let { data: profile } = await supabase
        .from('user_profiles')
        .select('first_name, last_name')
        .eq('user_id', userIdOrPhone)
        .single();

      if (profile) {
        const fullName = `${profile.first_name} ${profile.last_name}`.trim();
        console.log(`‚úÖ Found user name: ${fullName}`);
        return fullName;
      }

      // Try to find by WhatsApp number
      const { data: botUser } = await supabase
        .from('whatsapp_bot_users')
        .select('user_id')
        .eq('whatsapp_number', userIdOrPhone)
        .single();

      if (botUser) {
        const { data: profileByBotUser } = await supabase
          .from('user_profiles')
          .select('first_name, last_name')
          .eq('user_id', botUser.user_id)
          .single();

        if (profileByBotUser) {
          const fullName = `${profileByBotUser.first_name} ${profileByBotUser.last_name}`.trim();
          console.log(`‚úÖ Found user name via bot user: ${fullName}`);
          return fullName;
        }
      }

      console.log(`‚ùå No user name found for: ${userIdOrPhone}`);
      return 'Beloved Intercessor';
    } catch (error) {
      console.error('‚ùå Error fetching user name:', error);
      return 'Beloved Intercessor';
    }
  }

  private async logMessage(phoneNumber: string, content: string, direction: 'inbound' | 'outbound'): Promise<void> {
    try {
      await supabase
        .from('whatsapp_messages')
        .insert({
          whatsapp_number: phoneNumber,
          content: content,
          direction: direction,
          timestamp: new Date().toISOString()
        });
    } catch (error) {
      console.error('‚ùå Error logging message:', error);
    }
  }

  private async logInteraction(phoneNumber: string, interaction_type: string, command: string): Promise<void> {
    try {
      await supabase
        .from('whatsapp_interactions')
        .insert({
          whatsapp_number: phoneNumber,
          interaction_type: interaction_type,
          command: command,
          timestamp: new Date().toISOString()
        });
    } catch (error) {
      console.error('‚ùå Error logging interaction:', error);
    }
  }

  private async getUserByPhone(phoneNumber: string): Promise<WhatsAppBotUser | null> {
    try {
      const { data, error } = await supabase
        .from('whatsapp_bot_users')
        .select('*')
        .eq('whatsapp_number', phoneNumber)
        .single();

      if (error) {
        console.log(`‚ÑπÔ∏è No existing user found for ${phoneNumber}`);
        return null;
      }

      return data as WhatsAppBotUser;
    } catch (error) {
      console.error('‚ùå Error fetching user by phone:', error);
      return null;
    }
  }

  private async createOrUpdateUser(phoneNumber: string, userData: Partial<WhatsAppBotUser>): Promise<boolean> {
    try {
      const { error } = await supabase
        .from('whatsapp_bot_users')
        .upsert({
          whatsapp_number: phoneNumber,
          user_id: userData.user_id || `whatsapp_${phoneNumber}`,
          is_active: userData.is_active || true,
          reminder_preferences: userData.reminder_preferences || { reminderTiming: "30min", enabled: true },
          updated_at: new Date().toISOString()
        });

      if (error) {
        console.error('‚ùå Error creating/updating user:', error);
        return false;
      }

      console.log(`‚úÖ User created/updated successfully for ${phoneNumber}`);
      return true;
    } catch (error) {
      console.error('‚ùå Error in createOrUpdateUser:', error);
      return false;
    }
  }

  // Prayer slot reminders
  public async checkPrayerSlotReminders(): Promise<void> {
    console.log('üîç Checking prayer slot reminders using Supabase...');
    
    try {
      console.log('üîç Testing Supabase connection...');
      console.log('üîó Supabase URL:', process.env.SUPABASE_URL?.substring(0, 50) + '...');
      
      // Test basic connection
      const { data: connectionTest, error: connectionError } = await supabase
        .from('prayer_slots')
        .select('count', { count: 'exact', head: true });
      
      console.log('üîó Supabase connection test:', { success: !connectionError, error: connectionError?.message });
      
      if (connectionError) {
        console.error('‚ùå Failed to connect to Supabase:', connectionError);
        return;
      }
      
      console.log('üìä Database connection successful - checking for prayer slots data');
      
      // Query all prayer slots with detailed logging
      console.log('üîç Querying prayer_slots table directly...');
      const { data: allSlots, count: totalCount, error: queryError } = await supabase
        .from('prayer_slots')
        .select('*', { count: 'exact' });
      
      console.log('üìä ALL prayer_slots query result:', { 
        count: totalCount, 
        error: queryError?.message, 
        sample: allSlots?.[0] 
      });
      
      if (queryError) {
        console.error('‚ùå Error querying prayer slots:', queryError);
        return;
      }
      
      if (!allSlots || allSlots.length === 0) {
        console.log('‚ö†Ô∏è prayer_slots table is empty - no prayer slots available for reminders');
        console.log('üí° Add sample prayer slots using create-whatsapp-bot-tables.sql');
        return;
      }
      
      console.log(`‚úÖ BREAKTHROUGH! Found ${totalCount} total prayer slots in database!`);
      
      // Filter active slots
      const activeSlots = allSlots.filter(slot => slot.status === 'active');
      console.log(`‚úÖ Found ${activeSlots.length} active prayer slots out of ${totalCount} total slots`);
      
      if (activeSlots.length === 0) {
        console.log('‚ö†Ô∏è No active prayer slots found for reminders');
        return;
      }
      
      // Extract user IDs for debugging
      const userIds = activeSlots.map(slot => slot.user_id);
      console.log('üîç Extracted user IDs:', userIds);
      
      // Get WhatsApp bot users
      const { data: whatsappUsers, count: whatsappCount } = await supabase
        .from('whatsapp_bot_users')
        .select('*', { count: 'exact' })
        .eq('is_active', true);
      
      console.log(`üì± WhatsApp users found: ${whatsappCount || 0}`);
      
      // Get user profiles for names
      const { data: userProfiles, count: profilesCount, error: profilesError } = await supabase
        .from('user_profiles')
        .select('*', { count: 'exact' });
      
      console.log(`üë• User profiles found: ${profilesCount || 0}`);
      if (profilesError) {
        console.log('Error fetching user profiles:', profilesError);
      }
      
      if (!whatsappUsers || whatsappUsers.length === 0) {
        console.log('‚ö†Ô∏è No WhatsApp bot users found - no one to send reminders to');
        return;
      }
      
      // Process reminders for each active slot
      const currentTime = new Date();
      const currentMinutes = currentTime.getHours() * 60 + currentTime.getMinutes();
      
      for (const slot of activeSlots) {
        // Parse slot time (e.g., "04:00" or "14:30‚Äì15:00")
        const slotTimeStr = slot.slot_time.split('‚Äì')[0] || slot.slot_time;
        const [hours, minutes] = slotTimeStr.split(':').map(Number);
        const slotMinutes = hours * 60 + minutes;
        
        // Check if reminder should be sent (30 minutes before)
        const reminderMinutes = slotMinutes - 30;
        const timeDiff = Math.abs(currentMinutes - reminderMinutes);
        
        // Send reminder if within 1 minute of reminder time
        if (timeDiff <= 1) {
          const whatsappUser = whatsappUsers.find(user => user.user_id === slot.user_id);
          if (whatsappUser) {
            await this.sendPrayerSlotReminder(whatsappUser, slot);
          }
        }
      }
      
    } catch (error) {
      console.error('‚ùå Error in checkPrayerSlotReminders:', error);
    }
  }

  private async sendPrayerSlotReminder(user: WhatsAppBotUser, slot: PrayerSlot): Promise<void> {
    try {
      const userName = await this.getUserName(user.user_id);
      
      const message = `üïäÔ∏è *Prayer Reminder* üïäÔ∏è

Hello ${userName}! 

‚è∞ Your prayer slot (${slot.slot_time}) begins in 30 minutes.

üôè *"The effectual fervent prayer of a righteous man availeth much."* - James 5:16

May the Lord strengthen you as you stand in the gap for His people and purposes.

Reply *help* for more options.`;

      const success = await this.sendWhatsAppMessage(user.whatsapp_number, message);
      
      if (success) {
        console.log(`‚úÖ Prayer reminder sent to ${user.whatsapp_number} for slot ${slot.slot_time}`);
        await this.logInteraction(user.whatsapp_number, 'reminder', 'prayer_slot');
      }
    } catch (error) {
      console.error('‚ùå Error sending prayer slot reminder:', error);
    }
  }

  // Morning declarations
  private async sendMorningDeclarations(): Promise<void> {
    try {
      const { data: activeUsers } = await supabase
        .from('whatsapp_bot_users')
        .select('*')
        .eq('is_active', true);

      if (!activeUsers || activeUsers.length === 0) {
        console.log('‚ö†Ô∏è No active WhatsApp users found for morning declarations');
        return;
      }

      const declarations = `üåÖ *Good Morning, Prayer Warrior!* üåÖ

üî• *Today's Declarations:*

‚úùÔ∏è "This is the day the LORD has made; I will rejoice and be glad in it!" - Psalm 118:24

üõ°Ô∏è "No weapon formed against me shall prosper!" - Isaiah 54:17

üëë "I can do all things through Christ who strengthens me!" - Philippians 4:13

üôè May your prayers today move mountains and your intercession break every chain!

*Reply /help for bot commands*`;

      for (const user of activeUsers) {
        const userName = await this.getUserName(user.user_id);
        const personalizedMessage = declarations.replace('Prayer Warrior', userName);
        
        await this.sendWhatsAppMessage(user.whatsapp_number, personalizedMessage);
        await this.logInteraction(user.whatsapp_number, 'morning_declaration', 'daily');
      }

      console.log(`‚úÖ Morning declarations sent to ${activeUsers.length} users`);
    } catch (error) {
      console.error('‚ùå Error sending morning declarations:', error);
    }
  }

  // Authentication methods
  private async isUserAuthenticated(phoneNumber: string): Promise<{authenticated: boolean, userId?: string}> {
    try {
      // Check if user is authenticated by looking up whatsapp_bot_users table
      const { data: botUser, error } = await supabase
        .from('whatsapp_bot_users')
        .select('user_id, is_active')
        .eq('whatsapp_number', phoneNumber)
        .eq('is_active', true)
        .single();

      if (error || !botUser) {
        return { authenticated: false };
      }

      // Verify the user still exists in user_profiles
      const { data: userProfile, error: profileError } = await supabase
        .from('user_profiles')
        .select('id')
        .eq('id', botUser.user_id)
        .single();

      if (profileError || !userProfile) {
        return { authenticated: false };
      }

      return { authenticated: true, userId: botUser.user_id };
    } catch (error) {
      console.error('Error checking authentication:', error);
      return { authenticated: false };
    }
  }

  private async authenticateUser(phoneNumber: string, email: string, password: string): Promise<{success: boolean, userId?: string, message: string}> {
    try {
      console.log(`üîê Authenticating user: ${email}`);
      
      // Use Supabase auth to verify credentials
      const { data, error } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
      });

      if (error || !data.user) {
        console.log(`‚ùå Authentication failed for ${email}:`, error?.message);
        return { 
          success: false, 
          message: "Login failed. The email or password you provided was incorrect. Please try again, or visit the Global Intercessors web app if you need to reset your password. Remember to delete your password message after trying again." 
        };
      }

      const userId = data.user.id;
      console.log(`‚úÖ Authentication successful for ${email}, User ID: ${userId}`);

      // Get user profile data
      const { data: userProfile, error: profileError } = await supabase
        .from('user_profiles')
        .select('*')
        .eq('id', userId)
        .single();

      if (profileError || !userProfile) {
        return { 
          success: false, 
          message: "Your login was successful, but we couldn't find your profile. Please contact support." 
        };
      }

      // Create or update WhatsApp bot user record
      const { error: upsertError } = await supabase
        .from('whatsapp_bot_users')
        .upsert({
          user_id: userId,
          whatsapp_number: phoneNumber,
          is_active: true,
          timezone: userProfile.timezone || 'UTC',
          updated_at: new Date().toISOString()
        });

      if (upsertError) {
        console.error('Error creating WhatsApp bot user record:', upsertError);
        return { 
          success: false, 
          message: "Authentication was successful, but we couldn't link your WhatsApp account. Please try again." 
        };
      }

      // Log the interaction
      await this.logInteraction(phoneNumber, 'authentication', 'login_success');

      const userName = userProfile.fullName || userProfile.full_name || 'Beloved Intercessor';
      
      return { 
        success: true, 
        userId: userId,
        message: `Login successful! Welcome, ${userName}! You are now connected to your Global Intercessors account. You can now access your prayer slot reminders, daily scriptures, and more. Remember to delete your password message for security. How can I assist you today?` 
      };

    } catch (error) {
      console.error('Error in authentication process:', error);
      return { 
        success: false, 
        message: "An error occurred during login. Please try again later." 
      };
    }
  }

  private async sendLoginPrompt(phoneNumber: string): Promise<void> {
    const loginMessage = `Welcome to the Global Intercessors WhatsApp Bot! üïäÔ∏è

To access your personalized prayer features and account details, please log in with the same email and password you use for the Global Intercessors web app.

üìß Format your login like this:
Email: your_email@example.com
Password: your_secure_password

üîí *Important: For your security, please delete your message containing your password from our chat immediately after successful login. We will confirm once you are logged in.*

If you don't have an account yet, please sign up at the Global Intercessors web app first.`;

    await this.sendWhatsAppMessage(phoneNumber, loginMessage);
    await this.logInteraction(phoneNumber, 'authentication', 'login_prompt_sent');
  }

  private parseLoginCredentials(messageText: string): {email?: string, password?: string} {
    // Look for email and password in the message
    const emailMatch = messageText.match(/email:\s*([^\s\n]+)/i);
    const passwordMatch = messageText.match(/password:\s*([^\s\n]+)/i);
    
    if (emailMatch && passwordMatch) {
      return {
        email: emailMatch[1].trim(),
        password: passwordMatch[1].trim()
      };
    }
    
    // Try alternative format - lines with email and password
    const lines = messageText.split('\n');
    let email, password;
    
    for (const line of lines) {
      if (line.toLowerCase().includes('@') && !email) {
        email = line.trim();
      } else if (line.length > 5 && !password && !line.includes('@')) {
        password = line.trim();
      }
    }
    
    return { email, password };
  }

  // Command handlers
  public async handleIncomingMessage(phoneNumber: string, messageText: string, messageId: string): Promise<void> {
    console.log(`\nüì• INCOMING MESSAGE:`);
    console.log(`üì± From: ${phoneNumber}`);
    console.log(`üìù Text: ${messageText}`);
    console.log(`üÜî Message ID: ${messageId}`);

    // Prevent duplicate processing
    if (this.processedMessages.has(messageId)) {
      console.log('‚ö†Ô∏è Message already processed, skipping');
      return;
    }
    this.processedMessages.add(messageId);

    // Rate limiting
    const now = Date.now();
    const lastMessage = this.rateLimitMap.get(phoneNumber) || 0;
    if (now - lastMessage < 2000) { // 2 second rate limit
      console.log('‚ö†Ô∏è Rate limited, skipping message');
      return;
    }
    this.rateLimitMap.set(phoneNumber, now);

    // Log incoming message
    await this.logMessage(phoneNumber, messageText, 'inbound');

    try {
      // First, check if user is authenticated
      const authStatus = await this.isUserAuthenticated(phoneNumber);
      const command = messageText.toLowerCase().trim();
      
      // Handle authentication for non-authenticated users
      if (!authStatus.authenticated) {
        console.log(`üîê User ${phoneNumber} not authenticated, processing authentication`);
        
        // Check if this is a login attempt
        const credentials = this.parseLoginCredentials(messageText);
        
        if (credentials.email && credentials.password) {
          console.log(`üîê Processing login attempt from ${phoneNumber} with email: ${credentials.email}`);
          const authResult = await this.authenticateUser(phoneNumber, credentials.email, credentials.password);
          
          await this.sendWhatsAppMessage(phoneNumber, authResult.message);
          
          if (authResult.success) {
            // After successful login, show welcome message
            setTimeout(async () => {
              await this.handleStartCommand(phoneNumber, 'authenticated user');
            }, 2000);
          }
          return;
        }
        
        // For any other message from unauthenticated user, send login prompt
        console.log(`üìß Sending login prompt to unauthenticated user: ${phoneNumber}`);
        await this.sendLoginPrompt(phoneNumber);
        return;
      }
      
      console.log(`‚úÖ User ${phoneNumber} is authenticated, processing command: ${command}`);
      
      // Get or create user for existing flow
      let user = await this.getUserByPhone(phoneNumber);
      if (!user) {
        await this.createOrUpdateUser(phoneNumber, {});
        user = await this.getUserByPhone(phoneNumber);
      }

      // Process command - Get complete user information for personalized responses
      const userInfo = await this.getCompleteUserInfo(phoneNumber);
      console.log(`üéØ Processing command "${command}" for authenticated user: ${userInfo.name} (${userInfo.userId})`);
      
      const userName = userInfo.name;

      // User is authenticated - handle normal commands
      if (command === 'start' || command === '/start' || command === 'hi' || command === 'hello') {
        await this.handleStartCommand(phoneNumber, userName);
      } else if (command === 'devotionals' || command === '/devotionals') {
        await this.handleDevotionalsCommand(phoneNumber, userName);
      } else if (command === 'quiz' || command === '/quiz') {
        await this.handleQuizCommand(phoneNumber, userName);
      } else if (command === 'reminders' || command === '/reminders') {
        await this.handleRemindersCommand(phoneNumber, userName);
      } else if (command === 'updates' || command === '/updates') {
        await this.handleUpdatesCommand(phoneNumber, userName);
      } else if (command === 'messages' || command === '/messages') {
        await this.handleMessagesCommand(phoneNumber, userName);
      } else if (command === 'dashboard' || command === '/dashboard') {
        await this.handleDashboardCommand(phoneNumber, userName);
      } else if (command === 'help' || command === '/help') {
        await this.handleHelpCommand(phoneNumber, userName);
      } else if (command === 'stop' || command === '/stop') {
        await this.handleStopCommand(phoneNumber, userName);
      } else {
        await this.handleUnknownCommand(phoneNumber, userName, messageText);
      }
    } catch (error) {
      console.error('‚ùå Error handling message:', error);
      await this.sendWhatsAppMessage(phoneNumber, 
        `ü§ñ I apologize, but I encountered an error processing your message. Please try again or reply *help* for assistance.`
      );
    }
  }

  private async handleStartCommand(phoneNumber: string, userName: string): Promise<void> {
    await this.logInteraction(phoneNumber, 'command', 'start');

    // Get complete user information from database
    const userInfo = await this.getCompleteUserInfo(phoneNumber);
    
    const welcomeMessage = `üôè Hello, ${userInfo.name}!
Welcome to Global Intercessors Prayer Bot! üôå
${userInfo.slotInfo}

I'm your personal prayer companion, here to strengthen your walk with God through:

üìñ AI-Powered Devotionals ‚Äì Daily scriptures with fresh, Spirit-led insights
üß† Bible Quiz Challenge ‚Äì Test and grow your biblical knowledge  
‚è∞ Smart Prayer Reminders ‚Äì Never miss your intercession time
üåç Global Prayer Updates ‚Äì Join intercessors around the world in united prayer
‚ú® Fresh Messages ‚Äì Daily AI-generated declarations & prayer points
üìä Personal Dashboard ‚Äì Track and celebrate your spiritual growth

*"The effective, fervent prayer of a righteous man avails much."* ‚Äì James 5:16

Choose an option below to begin your spiritual journey:`;

    const buttons = [
      { id: 'devotionals', title: 'üìñ Devotionals' },
      { id: 'quiz', title: 'üß† Bible Quiz' },
      { id: 'reminders', title: '‚è∞ Reminders' }
    ];

    await this.sendInteractiveMessage(phoneNumber, welcomeMessage, buttons);
  }

  private async handleHelpCommand(phoneNumber: string, userName: string): Promise<void> {
    await this.logInteraction(phoneNumber, 'command', 'help');

    const helpMessage = `ü§ñ *Global Intercessors Bot Commands* ü§ñ

Hello ${userName}! Here are the available commands:

üîî **/remind** - Enable prayer slot reminders
üìñ **/devotional** - Get today's devotional content  
üõë **/stop** - Disable notifications
‚ùì **/help** - Show this help message

*Simply type any command to get started!*

üïäÔ∏è *"Pray without ceasing"* - 1 Thessalonians 5:17`;

    await this.sendWhatsAppMessage(phoneNumber, helpMessage);
  }

  private async handleDevotionalsCommand(phoneNumber: string, userName: string): Promise<void> {
    await this.logInteraction(phoneNumber, 'command', 'devotionals');

    const devotionalsMessage = `üìñ *Daily Devotionals* üìñ

Welcome ${userName} to your spiritual growth journey!

üî• Experience fresh, AI-powered devotionals featuring:
‚ú® Daily scripture with Spirit-led insights
üôè Personalized prayer points for your intercession
‚öîÔ∏è Prophetic declarations for breakthrough
üåç Global prayer focuses connecting you with believers worldwide

*"Your word is a lamp to my feet and a light to my path."* - Psalm 119:105

Choose your devotional experience:`;

    const buttons = [
      { id: 'daily_devotional', title: 'üìÖ Today\'s Devotional' },
      { id: 'fresh_word', title: '‚ú® Fresh Prophetic Word' },
      { id: 'scripture_insight', title: 'üîç Scripture Insight' }
    ];

    await this.sendInteractiveMessage(phoneNumber, devotionalsMessage, buttons);
  }

  private async handleQuizCommand(phoneNumber: string, userName: string): Promise<void> {
    await this.logInteraction(phoneNumber, 'command', 'quiz');

    const quizMessage = `üß† *Bible Quiz Challenge* üß†

Ready for a spiritual brain workout, ${userName}?

üìö Test and strengthen your biblical knowledge with:
üéØ Interactive Bible trivia questions
üìñ Scripture memory challenges  
üèÜ Progressive difficulty levels
üìà Track your spiritual growth
‚≠ê Earn badges for achievements
üåü Compete with fellow intercessors globally

*"Study to show yourself approved unto God, a workman that needs not to be ashamed."* - 2 Timothy 2:15

Select your challenge level:`;

    const buttons = [
      { id: 'easy_quiz', title: '‚≠ê Beginner Level' },
      { id: 'medium_quiz', title: '‚≠ê‚≠ê Intermediate' },
      { id: 'hard_quiz', title: '‚≠ê‚≠ê‚≠ê Advanced' }
    ];

    await this.sendInteractiveMessage(phoneNumber, quizMessage, buttons);
  }

  private async handleRemindersCommand(phoneNumber: string, userName: string): Promise<void> {
    await this.logInteraction(phoneNumber, 'command', 'reminders');

    // Update user preferences to enable reminders
    await this.createOrUpdateUser(phoneNumber, {
      reminder_preferences: { reminderTiming: "30min", enabled: true }
    });

    const reminderMessage = `‚è∞ *Smart Prayer Reminders* ‚è∞

Activated for ${userName}! 

‚úÖ You will receive gentle reminders 30 minutes before your prayer slot
üì± Customizable notification preferences
üîî Never miss your intercession time again
üìä Track your prayer consistency
üåç Join global prayer coverage

*"Continue earnestly in prayer, being vigilant in it with thanksgiving"* - Colossians 4:2

Your faithfulness in prayer makes an eternal difference!

Choose your reminder settings:`;

    const buttons = [
      { id: 'reminder_30min', title: '‚è∞ 30 Min Before' },
      { id: 'reminder_15min', title: '‚è∞ 15 Min Before' },
      { id: 'reminder_custom', title: '‚öôÔ∏è Custom Settings' }
    ];

    await this.sendInteractiveMessage(phoneNumber, reminderMessage, buttons);
  }

  private async handleUpdatesCommand(phoneNumber: string, userName: string): Promise<void> {
    await this.logInteraction(phoneNumber, 'command', 'updates');

    const updatesMessage = `üåç *Global Prayer Updates* üåç

Stay connected, ${userName}!

üåé Join intercessors worldwide in united prayer for:
üî• Global revival movements
üïäÔ∏è Peace in nations facing conflict  
‚õ™ Church growth in restricted regions
üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family restoration worldwide
üè• Healing for the nations
üíº Economic breakthrough for believers

*"If my people, who are called by my name, will humble themselves and pray..."* - 2 Chronicles 7:14

Choose your prayer focus:`;

    const buttons = [
      { id: 'urgent_prayer', title: 'üö® Urgent Requests' },
      { id: 'global_focus', title: 'üåç Global Focus' },
      { id: 'revival_watch', title: 'üî• Revival Watch' }
    ];

    await this.sendInteractiveMessage(phoneNumber, updatesMessage, buttons);
  }

  private async handleMessagesCommand(phoneNumber: string, userName: string): Promise<void> {
    await this.logInteraction(phoneNumber, 'command', 'messages');

    const messagesMessage = `‚ú® *Fresh Messages* ‚ú®

AI-Generated spiritual content for ${userName}!

üî• Receive powerful, Spirit-inspired content:
‚öîÔ∏è Daily warfare declarations
üôè Personalized prayer points
üìú Prophetic insights and words
üí™ Faith-building affirmations
üåü Breakthrough confessions
üéØ Targeted intercession focuses

*"Death and life are in the power of the tongue."* - Proverbs 18:21

Select your message type:`;

    const buttons = [
      { id: 'warfare_declaration', title: '‚öîÔ∏è Warfare Declarations' },
      { id: 'prophetic_word', title: 'üìú Prophetic Insights' },
      { id: 'prayer_points', title: 'üôè Prayer Points' }
    ];

    await this.sendInteractiveMessage(phoneNumber, messagesMessage, buttons);
  }

  private async handleDashboardCommand(phoneNumber: string, userName: string): Promise<void> {
    await this.logInteraction(phoneNumber, 'command', 'dashboard');

    const prayerSlot = await this.getUserPrayerSlot(phoneNumber);
    const slotDisplay = prayerSlot ? `Your slot: ${prayerSlot}` : 'No slot assigned';

    const dashboardMessage = `üìä *Personal Dashboard* üìä

Spiritual Progress Report for ${userName}

üìà **Your Prayer Journey:**
‚è∞ ${slotDisplay}
üéØ Prayer consistency: Building momentum!
üèÜ Spiritual milestones: Growing in faith
üìö Bible knowledge: Expanding wisdom
üåü Global impact: Making a difference

*"Being confident of this very thing, that He who has begun a good work in you will complete it."* - Philippians 1:6

View your detailed progress:`;

    const buttons = [
      { id: 'prayer_stats', title: 'üìà Prayer Statistics' },
      { id: 'growth_report', title: 'üå± Growth Report' },
      { id: 'achievements', title: 'üèÜ Achievements' }
    ];

    await this.sendInteractiveMessage(phoneNumber, dashboardMessage, buttons);
  }

  private async handleDevotionalCommand(phoneNumber: string, userName: string): Promise<void> {
    await this.logInteraction(phoneNumber, 'command', 'devotional');

    const devotionalMessage = `üìñ *Today's Devotional* üìñ

Hello ${userName}!

üî• *"For the eyes of the LORD run to and fro throughout the whole earth, to show Himself strong on behalf of those whose heart is loyal to Him."* - 2 Chronicles 16:9

üí° **Reflection:** God is actively seeking hearts completely devoted to Him. Your prayers today are part of His mighty work across the earth.

‚öîÔ∏è **Declaration:** "Lord, I position my heart in complete loyalty to You. Use my prayers to demonstrate Your strength in every nation!"

üåç **Intercession Focus:** Pray for spiritual awakening in unreached nations and for God's strength to be revealed through global intercession.

Reply **/devotional** for fresh content anytime!`;

    await this.sendWhatsAppMessage(phoneNumber, devotionalMessage);
  }

  private async handleStopCommand(phoneNumber: string, userName: string): Promise<void> {
    await this.logInteraction(phoneNumber, 'command', 'stop');

    // Update user preferences to disable reminders
    await this.createOrUpdateUser(phoneNumber, {
      is_active: false,
      reminder_preferences: { reminderTiming: "30min", enabled: false }
    });

    const stopMessage = `üõë *Notifications Disabled* üõë

${userName}, your prayer reminders have been disabled.

üïäÔ∏è You can reactivate them anytime by typing **/remind**

*"The LORD bless you and keep you!"* - Numbers 6:24

Thank you for your heart for intercession!`;

    await this.sendWhatsAppMessage(phoneNumber, stopMessage);
  }

  private async handleUnknownCommand(phoneNumber: string, userName: string, messageText: string): Promise<void> {
    await this.logInteraction(phoneNumber, 'unknown_command', messageText);

    const unknownMessage = `ü§î *Command Not Recognized* ü§î

Hello ${userName}! I didn't understand "${messageText}".

‚ú® *Try these commands:*
‚Ä¢ **/help** - View all commands
‚Ä¢ **/remind** - Enable prayer reminders  
‚Ä¢ **/devotional** - Get spiritual content
‚Ä¢ **/stop** - Disable notifications

üôè *"Call to Me, and I will answer you"* - Jeremiah 33:3`;

    await this.sendWhatsAppMessage(phoneNumber, unknownMessage);
  }

  // Webhook verification for Meta WhatsApp Business API
  public verifyWebhook(mode: string, token: string, challenge: string): string | null {
    const verifyToken = process.env.WHATSAPP_WEBHOOK_VERIFY_TOKEN || 'GI_PRAYER_BOT_VERIFY_2024';
    
    if (mode === 'subscribe' && token === verifyToken) {
      console.log('‚úÖ Webhook verified successfully');
      return challenge;
    } else {
      console.error('‚ùå Webhook verification failed');
      return null;
    }
  }

  // Process webhook data from Meta WhatsApp Business API
  public async processWebhookData(body: any): Promise<void> {
    console.log('üì• Processing webhook data...');
    
    try {
      if (body.object === 'whatsapp_business_account') {
        for (const entry of body.entry || []) {
          for (const change of entry.changes || []) {
            if (change.value && change.value.messages) {
              for (const message of change.value.messages) {
                if (message.type === 'text') {
                  await this.handleIncomingMessage(
                    message.from,
                    message.text.body,
                    message.id
                  );
                }
              }
            }
          }
        }
      }
    } catch (error) {
      console.error('‚ùå Error processing webhook data:', error);
    }
  }
}

// Export singleton instance
export const whatsAppBot = new WhatsAppPrayerBot();